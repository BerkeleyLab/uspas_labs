# How to program bitstream file for LLRF chassis
---

In any of the directories, run

```bash
make config_marble
```

# Python environment setup (for developers)
---

Install [miniconda](https://docs.conda.io/en/main/miniconda.html). Tested with conda  22.11.1 on both MacOs 12.6.2 and Debian Linux 11.

Create environment:

```bash
conda env create -f environment.yml
```

# Prerequisites for running IOC and Phoebus

In order to run the IOC and Phoebus the following tools
are needed to be installed on the host machine:

* Docker 20.10.22 (other versions might work)

Follow the instructions from the [Docker website](https://docs.docker.com/get-docker/)

# How to get docker images for the EPICS IOC and Phoebus

There are some ways to get those images.

The straightforward way is to get the images from
dockerhub with:

```bash
docker pull lerwys/epics_feed_alsu
docker pull lerwys/epics_phoebus_alsu
```

In case you don't have a good internet connections you can also
load them from a tarball with:

```bash
docker load < epics_feed_alsu.tar
docker load < epics_phoebus_alsu.tar
```

To check if you have the images you can use:

```bash
docker images
```

And you should see at least:

```code
lrusso@lrussoPC:~$ docker images
REPOSITORY                  TAG                        IMAGE ID       CREATED       SIZE
lerwys/epics_phoebus_alsu   latest                     7018504ada34   4 hours ago   3.01GB
lerwys/epics_feed_alsu      latest                     c43a862113b2   4 hours ago   2.36GB
```

# How to run EPICS IOC
---

1. Open a terminal
2. Run the FEED ALSU image, which contains the EPICS IOC, with:

```bash
docker run --rm -it --name feed_alsu --network="host" lerwys/epics_feed_alsu
```

You should see something like the following:

```code
#!../../bin/linux-x86_64/alsuRfIoc
< envPaths
epicsEnvSet("IOC","sioc-ar-llrf2")
epicsEnvSet("TOP","/usr/local/epics/7.0.7/modules/FEED")
epicsEnvSet("ASYN","/usr/local/epics/7.0.7/modules/asyn-R4-31")
epicsEnvSet("BUSY","/usr/local/epics/7.0.7/modules/busy-R1-6-1")
epicsEnvSet("AUTOSAVE","/usr/local/epics/7.0.7/modules/autosave-R5-8")
epicsEnvSet("QF2PREMONITOR","/usr/local/epics/7.0.7/modules/QF2preMonitor-R0.1.2")
epicsEnvSet("EPICS_BASE","/usr/local/epics/7.0.7/base")
epicsEnvSet("CTRL_IPADDR", "192.168.19.122:803")
epicsEnvSet("EPICS_CA_MAX_ARRAY_BYTES", "1000000")
epicsEnvSet("PREFIX", "USPAS:LLRF")
epicsEnvSet("REGSCAN", ".5 second")
epicsEnvSet("DB_TOP", "/usr/local/epics/7.0.7/modules/FEED/db")
epicsEnvSet("IOCSH_TOP","/usr/local/epics/7.0.7/base/../modules/soft/iocsh")
epicsEnvSet("ENGINEER", "qdu")
epicsEnvSet("LOCATION", "XXX")
epicsEnvSet("WIKI", "llrf")
epicsEnvSet("IOCNAME", "sioc-ar-llrf2")
dbLoadDatabase("../../dbd/alsuRfIoc.dbd",0,0)
alsuRfIoc_registerRecordDeviceDriver(pdbbase)
var(feedNumInFlight, 16)
epicsEnvSet("EPICS_DB_INCLUDE_PATH", ".:../../db")
# Fix rom address in src/driver/device.cpp and src/python/leep/raw.py
# The file "alsu_llrf_registers.substitutions" was generated by running:
# cd ../../src/python
# python -m leep.cli -d leep://192.168.19.122:803 template ../../src/Db/alsu_llrf_registers.substitutions
#
# By default all records connected to registers have SCAN=Passive
dbLoadTemplate("../../db/alsu_llrf_registers.substitutions","CHAS=USPAS:LLRF,NAME=device,REGSCAN=.5 second,DEBUG=0")
# LLRF waveform acquisition
dbLoadTemplate("../../db/alsu_llrf_logic.substitutions", "CHAS=USPAS:LLRF,NAME=device,TPRO=0")
dbLoadRecords("../../db/wf_config_llrf.db", "CHAS=USPAS:LLRF")
dbLoadRecords("../../db/llrf_cal.db", "CHAS=USPAS:LLRF,NAME=device,TPRO=0")
dbLoadRecords("../../db/system.db", "P=USPAS:LLRF,NAME=device,REGSCAN=.5 second,TPRO=0")
iocInit()
Starting iocInit
############################################################################
## EPICS R7.0.7
## Rev. 2023-01-17T14:22-0800
## Rev. Date build date/time:
############################################################################
2023/01/18 15:14:02.438467479 device : reset w/
# Create FEED Device device
# Listening @ 0.0.0.0:42197
iocRun: All initialization complete
dbl > records.dbl
# TODO: different IP address
dbpf "USPAS:LLRF:CTRL_IPADDR" "192.168.19.122:803"
DBF_STRING:         "192.168.19.122:803"
epics>
```

The last line `epics>` shows that you have access to the EPICS IOC
command line interface, which can be used for debugging purposes and
some special EPICS commands.

Leave the IOC running and don't close the terminal.

# How to run Phoebus GUI
---

1. Open a new terminal
2. Run the Phoebus GUI application, which contains the client screens, with:

```bash
xhost local:root
docker run --rm -it --name phoebus_alsu --network="host" -e DISPLAY=${DISPLAY} -v /tmp/.X11-unix:/tmp/.X11-unix -v $HOME/.Xauthority:/root/.Xauthority lerwys/epics_phoebus_alsu
```

You should see the `Phoebus` splash screen and the LLRF screens

# Useful Docker commands
---

There are some useful docker commands that can help troubleshoot some issues.

* List the running containers:

```bash
docker ps
```

* Login into a running container:

```bash
docker exec -it <container_name> bash
```

* Update an image from the docker registry:

```bash
docker pull <ORGANIZATION>/<IMAGE_NAME>
```

* Load an image from a .tar file:

```bash
docker load < <TAR_FILE>
```

* List images currently on your computer:

```bash
docker images
```

* Remove image from your computer:

```bash
docker rmi <IMAGE_ID>
```

* Run an image interactively:

```bash
docker run --rm -it --name test --network="host" <ORGANIZATION>/<IMAGE_NAME> bash
```
